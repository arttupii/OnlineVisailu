<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Pelaaja - Visailu</title>
	<link href="/static/bootstrap.min.css" rel="stylesheet">
	<link href="/static/main.css" rel="stylesheet">
</head>

<body>
	<div class="container mt-5">
		<div class="row justify-content-center">
			<div class="col-lg-6">
				<div class="card">
					<div class="card-body">
						<h1 class="card-title text-center mb-4" style="font-size: 1.5rem;">
							Tervetuloa osallistumaan online-visailupeliin!
						</h1>
						<div class="text-center mb-4">
							<h2 id="questionText">Odotathan pelin alkua...</h2>
						</div>
						<div id="timer" class="text-center mb-3" style="display: none;">
							Aikaa jäljellä: <span id="remainingTime">0</span> sekuntia
						</div>
						<div id="options" class="d-grid gap-2">
							<!-- Kysymyksen vaihtoehdot tulevat tähän -->
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="/static/bootstrap.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		const urlParams = new URLSearchParams(window.location.search);
		const nickname = urlParams.get('nickname');
		const gameId = urlParams.get('gameId');

		// Tarkistetaan, onko nimimerkki ja pelitunnus annettu URL:issa
		if (!nickname || !gameId) {
			alert('Nimimerkki tai pelikoodi puuttuu!');
			window.location.href = '/'; // Ohjataan takaisin pääsivulle
		}

		const socket = io.connect('http://localhost:3000');

		// Lähetä 'joinGame' tapahtuma pelitunnuksen ja nimi-merkin kanssa
		socket.emit('joinGame', { gameId, nickname });

		socket.on('joinedGame', ({ success, message }) => {
			if (!success) {
				alert(message);
				window.location.href = '/';
			}
			// Lisätoimenpiteet, kun pelaaja liittyy onnistuneesti
		});

		let timerInterval = null;

		// Kuunellaan 'newQuestion' tapahtumaa palvelimelta.
		socket.on('newQuestion', (question) => {
			// if #timer is hidden, show it
			const timerDiv = document.getElementById('timer');
			timerDiv.style.display = 'block';

			displayQuestion(question);
			startTimer(question.duration);
		});

		// Kuunellaan 'gameOver' tapahtumaa palvelimelta.
		socket.on('gameOver', async ({ score }) => {
			const response = await fetch('/getWinner', {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ gameId })
			});

			const resp = await response.json();

			console.info(`[DEBUG]: Vastaus vastaanotettu palvelimelta!`);

			const timerDiv = document.getElementById('timer');
			timerDiv.style.display = 'none';

			if (resp.success) {
				const questionText = document.getElementById('questionText');
				questionText.style.fontSize = '1.5rem';
				questionText.innerText = `Peli päättyi, voittaja on: ${resp.winner} pisteillä ${score}!`;
			} else {
				console.error('Virhe voittajan hakemisessa!', resp.message);
			}

			const optionsDiv = document.getElementById('options');
			optionsDiv.innerHTML = '';
			const btn = document.createElement('a');
			btn.href = '/';
			btn.innerText = 'Siirry takaisin etusivulle!';
			btn.className = 'btn btn-primary';
			optionsDiv.appendChild(btn);
		});

		// Funktio vastauksen käsittelyyn
		function answerQuestion(selectedOption, btnElement, correctAnswer) {
			// Poista kaikkien vaihtoehtopainikkeiden toiminta
			const optionButtons = document.querySelectorAll('#options button');
			optionButtons.forEach(button => {
				button.disabled = true;
				button.style.cursor = 'not-allowed';
				button.style.pointerEvents = 'none';
				button.style.borderColor = "#fff";
				button.style.color = "#000";
			});

			btnElement.style.backgroundColor = selectedOption === correctAnswer ? "#16a34a" : "#dc2626";

			btnElement.style.borderColor = selectedOption === correctAnswer ? "#16a34a" : "#dc2626";
			btnElement.style.color = selectedOption === correctAnswer ? "#ffffff" : "#ffffff";

			// Lähetä valittu vaihtoehto palvelimelle
			socket.emit('answer', { gameId, option: selectedOption });
		}

		// Aloitetaan ajastin
		function startTimer(duration) {
			let remainingTime = duration;
			const timerElement = document.getElementById('remainingTime');
			timerElement.innerText = remainingTime;

			// Päivitä ajastin joka sekunti
			if (timerInterval) {
				clearInterval(timerInterval);
			}
			timerInterval = setInterval(() => {
				remainingTime -= 1;
				timerElement.innerText = remainingTime;

				if (remainingTime <= 0) {
					clearInterval(timerInterval);
					// Käsittele tilanne, kun aika loppuu
				}
			}, 1000);
		}

		// Näytetään kysymys ja vaihtoehdot
		function displayQuestion(question) {
			document.getElementById('questionText').innerText = question.question;

			const optionsDiv = document.getElementById('options');
			optionsDiv.innerHTML = '';  // Tyhjennä edelliset vaihtoehdot

			// Sekoita vaihtoehdot
			const randomizedOptions = mixArray(question.options, 5)
			randomizedOptions.forEach(option => {
				const btn = document.createElement('button');
				btn.innerText = option;
				btn.onclick = () => answerQuestion(option, btn, question.correctAnswer);
				optionsDiv.appendChild(btn);
			});
		}

		// Funktio taulukon sekoittamiseen
		function mixArray(array, times) {
			let mixedArray = [...array];

			for (let i = 0; i < times; i++) {
				for (let j = mixedArray.length - 1; j > 0; j--) {
					const randomIndex = Math.floor(Math.random() * (j + 1));
					[mixedArray[j], mixedArray[randomIndex]] = [mixedArray[randomIndex], mixedArray[j]];
				}
			}

			return mixedArray;
		}
	</script>
</body>

</html>